import * as core from "@actions/core";
import { Octokit } from "@octokit/rest";
const octokit = new Octokit({
  auth: process.env.HUNTR_HELPER_PIPELINE_TOKEN,
});

var vulnerabilityJson = JSON.parse(process.env.VULNERABILITY_JSON);
const vulnerabilityJsonPath = process.env.VULNERABILITY_JSON_PATH;
const vulnerabilityJsonSha = process.env.VULNERABILITY_JSON_SHA;

const bountyId = `${vulnerabilityJson.PackageVulnerabilityID}-${vulnerabilityJson.Package.Registry}-${vulnerabilityJson.Package.Name}`;
const disclosureDate = new Date().toISOString().slice(0, 10).toString();
const discloserId = process.env.DISCLOSER_ID.toString();
const prNumber = process.env.PR_NUMBER.toString();

console.log(`Updating vulnerability.json contents:
    - Path: ${vulnerabilityJsonPath}
    - SHA: ${vulnerabilityJsonSha}

    - Bounty ID: ${bountyId}
    - DisclosureDate: ${disclosureDate}
    - Contributor.Discloser: ${discloserId}
    - PrNumber: ${prNumber}`);

vulnerabilityJson.DisclosureDate = disclosureDate;
vulnerabilityJson.Contributor.Discloser = discloserId;
vulnerabilityJson.PrNumber = prNumber;

await octokit.repos
  .createOrUpdateFileContents({
    owner: "418sec",
    repo: "huntr",
    path: vulnerabilityJsonPath,
    message: `[${bountyId}] Appended DisclosureDate, Discloser & PrNumber to vulnerability.json`,
    content: Buffer.from(
      JSON.stringify(vulnerabilityJson, null, 4),
      "utf8"
    ).toString("base64"),
    sha: vulnerabilityJsonSha,
    branch: "staging",
    committer: {
      name: "huntr.dev | the place to protect open source",
      email: "admin@418sec.com",
    },
    author: {
      name: "huntr.dev | the place to protect open source",
      email: "admin@418sec.com",
    },
  })
  .then(() => {
    console.log("Updated vulnerability.json contents successfully.");
  })
  .catch((error) => {
    core.setFailed("Could not update vulnerability.json contents:", error);
  });
